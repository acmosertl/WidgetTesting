<!-- PART A: HTML — Madhabam Bengali Calendar + Panchika panel -->
<div id="madhabam-app" class="madhabam-root">
  <header class="mb-header">
    <div class="mb-title">
      <div class="mb-bangla-month" id="mbBanglaMonth">…</div>
      <div class="mb-greg-small" id="mbGregSmall">…</div>
    </div>
    <div class="mb-controls">
      <button id="prevMonth">&larr;</button>
      <button id="todayBtn">আজ</button>
      <button id="nextMonth">&rarr;</button>
      <select id="modeSelect" title="Mode (drik / surya)">
        <option value="drik">দৃক (Govt)</option>
        <option value="surya">সূর্য (Surya)</option>
      </select>
    </div>
  </header>

  <main class="mb-main">
    <section class="mb-calendar-wrap">
      <div class="mb-weeknames">
        <div>রবি</div><div>সোম</div><div>মঙ্গল</div><div>বুধ</div><div>বৃহঃ</div><div>শুক্র</div><div>শনি</div>
      </div>

      <div id="mbCalendarGrid" class="mb-grid">
        <!-- JS will populate 6x7 cells -->
      </div>
    </section>

    <aside class="mb-sidepanel" id="mbDetailPanel">
      <div class="panel-card">
        <h3 id="detailDateTitle">—</h3>
        <div class="detail-row"><strong>স্থান:</strong> <span id="detailPlace">—</span></div>
        <div class="detail-row"><strong>সূর্যোদয় / অস্ত:</strong> <span id="detailSun">—</span></div>
        <div class="detail-row"><strong>তিথি:</strong> <span id="detailTithi">—</span></div>
        <div class="detail-row"><strong>পক্ষ:</strong> <span id="detailPaksha">—</span></div>
        <div class="detail-row"><strong>নক্ষত্র:</strong> <span id="detailNakshatra">—</span></div>
        <div class="detail-row"><strong>লগ্ন:</strong> <span id="detailLagna">—</span></div>
        <div class="detail-row"><strong>যোগ / করন:</strong> <span id="detailYoga">—</span></div>

        <h4>অনুষ্ঠান / শুভ-সময়</h4>
        <div id="detailFestivals"></div>

        <h4>পূর্ণ পঞ্জিকা রিপোর্ট</h4>
        <pre id="detailRaw" class="raw-block">loading…</pre>
      </div>
    </aside>
  </main>

  <footer class="mb-footer">
    <div>Auto-refresh: hourly · Engine: Madhabam Panchika V12</div>
  </footer>
</div>

<style>
/* PART B — Madhabam calendar CSS (paste after Part A) */
.madhabam-root{font-family: "Noto Sans Bengali", "Him", serif; max-width:1100px;margin:12px auto;background:#fff1f6;border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06);}
.mb-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.mb-title{display:flex;flex-direction:column}
.mb-bangla-month{font-size:28px;color:#6d2671;font-weight:700}
.mb-greg-small{font-size:13px;color:#8b6f6f}
.mb-controls button, #modeSelect{margin-left:6px;padding:6px 10px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);background:#fff}
.mb-main{display:flex;gap:14px}
.mb-calendar-wrap{flex:1}
.mb-weeknames{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:6px}
.mb-weeknames>div{background:transparent;padding:8px;text-align:center;color:#3a2a76;font-weight:700}
.mb-grid{display:grid;grid-template-columns:repeat(7,1fr);grid-auto-rows:110px;gap:8px}
.mb-cell{background:linear-gradient(180deg,#ffdff1,#f6cfe0);border-radius:10px;padding:8px;position:relative;overflow:hidden;border:1px solid rgba(0,0,0,0.03)}
.mb-cell.inactive{opacity:0.35;background:#f6efe9}
.mb-cell .date-num{font-size:28px;color:#1f3a82;font-weight:800}
.mb-cell .bn-day-small{position:absolute;top:8px;right:8px;color:#6d3a6d;font-weight:700}
.mb-cell .event-line{position:absolute;bottom:8px;left:8px;right:8px;font-size:12px;color:#096bb0}
.mb-cell.highlight{outline:3px solid rgba(255,183,179,0.6)}
.mb-sidepanel{width:360px}
.panel-card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.06)}
.panel-card h3{margin:0 0 8px 0;color:#6d2671}
.detail-row{margin:8px 0;font-size:14px;color:#333}
#detailFestivals{margin:6px 0;padding:6px;border-radius:6px;background:linear-gradient(180deg,#fff,#fff3fb)}
.raw-block{white-space:pre-wrap;background:#f7f1f6;padding:10px;border-radius:6px;font-size:12px;color:#444}
.mb-footer{margin-top:10px;text-align:center;color:#7a6b6b;font-size:13px}
/* responsive */
@media(max-width:980px){
  .mb-main{flex-direction:column}
  .mb-sidepanel{width:100%}
  .mb-grid{grid-auto-rows:100px}
}
</style>

<script>
/* PART C — JS: Panchika engine + Calendar UI + Festival rules
   Paste this after Parts A+B. Self-contained; no required external APIs.
*/

/* ---------- Utilities & Constants ---------- */
const D2R = Math.PI/180, R2D = 180/Math.PI;
const DAYS_BN = ["রবিবার","সোমবার","মঙ্গলবার","বুধবার","বৃহস্পতিবার","শুক্রবার","শনিবার"];
const SIGN_NAMES_BN = ["মেষ","বৃষ","মিথুন","কর্কট","সিংহ","কন্যা","তুলা","বৃশ্চিক","ধনু","মকর","কুম্ভ","মীন"];
// MODE
let MODE = localStorage.getItem("madhabam_mode_v7") || "drik";

/* ---------- Astronomical helpers (approx high-quality formulas) ---------- */
function JD(y,m,d,ut=0){
  if(m<=2){ y--; m+=12; }
  const A=Math.floor(y/100), B=2-A+Math.floor(A/4);
  return Math.floor(365.25*(y+4716)) + Math.floor(30.6001*(m+1)) + d + B - 1524.5 + ut/24;
}
function norm360(x){ return ((x%360)+360)%360; }
function gmst(J){
  const T=(J-2451545)/36525;
  return norm360(280.46061837 + 360.98564736629*(J-2451545) + 0.000387933*T*T - T*T*T/38710000);
}
function obliq(T){ return 23.439291 - 0.0130042*T; }

/* Ecliptic -> RA/Dec (approx using only longitude) */
function eclToEq(lon, J){
  const eps = obliq((J-2451545)/36525) * D2R;
  const L = lon * D2R;
  const ra = Math.atan2(Math.sin(L)*Math.cos(eps), Math.cos(L)) * R2D;
  const dec = Math.asin(Math.sin(eps)*Math.sin(L)) * R2D;
  return { ra: ((ra%360)+360)%360, dec };
}
function lstDeg(J, lon){ return (gmst(J) + lon) % 360; }
function altDeg(dec, ha, lat){
  return Math.asin(Math.sin(lat*D2R)*Math.sin(dec*D2R) + Math.cos(lat*D2R)*Math.cos(dec*D2R)*Math.cos(ha*D2R)) * R2D;
}

/* Sun and Moon longitude (approx) */
function sunLong(J){
  const d=J-2451545;
  const M = norm360(357.52911 + 0.98560028*d);
  return norm360(280.46646 + 0.98564736*d + 1.9146*Math.sin(M*D2R) + 0.02*Math.sin(2*M*D2R));
}
function moonLong(J){
  const d=J-2451545;
  const Lm = norm360(218.3165 + 13.176358*d);
  const D  = norm360(297.8501921 + 12.19074912*d);
  const Ms = norm360(357.5291092 + 0.98560028*d);
  const Mm = norm360(134.9633964 + 13.06499295*d);
  return norm360(Lm + 6.289*Math.sin(Mm*D2R) + 1.274*Math.sin((2*D-Mm)*D2R) + 0.658*Math.sin(2*D*D2R) - 0.186*Math.sin(Ms*D2R));
}

/* MODE params (drik/surya) */
const MODE_PARAMS = {
  surya:{ sun_h0:-0.833, moon_h0:+0.125, sun_corr_deg:0.00, moon_corr_deg:0.00, tithi_bias_deg:0.00, ayan:()=>24.0 },
  drik :{ sun_h0:-0.833, moon_h0:+0.25,  sun_corr_deg:0.28, moon_corr_deg:3.50, tithi_bias_deg:0.25, ayan:()=>24.0 }
};
function correctedSunLong(J){ return norm360(sunLong(J) + (MODE_PARAMS[MODE]?.sun_corr_deg||0)); }
function correctedMoonLong(J){ return norm360(moonLong(J) + (MODE_PARAMS[MODE]?.moon_corr_deg||0)); }

/* tithi/nakshatra */
function tithiInfoAt(J){
  const p = MODE_PARAMS[MODE] || MODE_PARAMS.surya;
  const ls = correctedSunLong(J);
  const lm = correctedMoonLong(J);
  const diff = norm360(lm - ls + (p.tithi_bias_deg||0));
  const num = Math.floor(diff/12) + 1; // 1..30
  const paksha = (num<=15) ? "শুক্লপক্ষ" : "কৃষ্ণপক্ষ";
  return { num, paksha, angle: diff };
}
function siderealMoonLong(J){
  const ay = (MODE_PARAMS[MODE]?.ayan?.()) || 24.0;
  return norm360(correctedMoonLong(J) - ay);
}
function nakIdx(J){ return Math.floor(siderealMoonLong(J) / (360/27)) % 27; }

/* binary search for tithi/nak end times (returns JD UTC) */
function tithiEndUTC(Jstart){
  const cur = tithiInfoAt(Jstart).num;
  let lo=Jstart, hi=Jstart+2;
  for(let i=0;i<40;i++){ const mid=(lo+hi)/2; const n=tithiInfoAt(mid).num; if(n!==cur) hi=mid; else lo=mid; }
  return hi;
}
function nakEndUTC(Jstart){
  const cur = nakIdx(Jstart);
  let lo=Jstart, hi=Jstart+1.5;
  while (nakIdx(hi)===cur && (hi-Jstart)<2.0) hi += 0.1;
  for(let i=0;i<40;i++){ const mid=(lo+hi)/2; const idx=nakIdx(mid); if(idx!==cur) hi=mid; else lo=mid; }
  return hi;
}

/* Sunrise/Sunset solver per day (J0 = JD at 0h UTC) */
function solarRiseSetUTC_raw(J0, lat, lon, h0){
  let rise=null, setv=null;
  for(let k=0;k<24;k++){
    const a = J0 + k/24, b = J0 + (k+1)/24;
    const La = eclToEq(sunLong(a), a), Lb = eclToEq(sunLong(b), b);
    const Ha = ((lstDeg(a,lon)/15 - La.ra)*15 + 540)%360 - 180;
    const Hb = ((lstDeg(b,lon)/15 - Lb.ra)*15 + 540)%360 - 180;
    const Aa = altDeg(La.dec, Ha, lat) - h0;
    const Ab = altDeg(Lb.dec, Hb, lat) - h0;
    if(Aa<0 && Ab>0 && rise===null){
      let lo=a, hi=b;
      for(let i=0;i<24;i++){
        const m=(lo+hi)/2;
        const L=eclToEq(sunLong(m), m);
        const H = ((lstDeg(m,lon)/15 - L.ra)*15 + 540)%360 - 180;
        const A = altDeg(L.dec, H, lat) - h0;
        if(A<0) lo=m; else hi=m;
      }
      rise = ((lo+hi)/2 - J0)*24;
    }
    if(Aa>0 && Ab<0 && setv===null){
      let lo=a, hi=b;
      for(let i=0;i<24;i++){
        const m=(lo+hi)/2;
        const L=eclToEq(sunLong(m), m);
        const H = ((lstDeg(m,lon)/15 - L.ra)*15 + 540)%360 - 180;
        const A = altDeg(L.dec, H, lat) - h0;
        if(A>0) lo=m; else hi=m;
      }
      setv = ((lo+hi)/2 - J0)*24;
    }
  }
  return { riseUTC: rise, setUTC: setv };
}

/* Format helpers */
function fmt12(h){
  if(h==null || isNaN(h)) return "—";
  h = (h+24)%24;
  const ap = h>=12 ? "PM" : "AM";
  let hh = Math.floor(h%12); if(hh===0) hh=12;
  const mm = String(Math.round((h%1)*60)).padStart(2,"0");
  return `${hh}:${mm} ${ap}`;
}
function toLocalFromJD(J) {
  // J is JD UTC; convert to local Date object (approx) using JS timezone
  // JD -> milliseconds
  const unixSecs = (J - 2440587.5) * 86400;
  return new Date(unixSecs*1000);
}

/* Bangabda month determination (basic by sun longitude) */
const B_MONTHS=["বৈশাখ","জ্যৈষ্ঠ","আষাঢ়","শ্রাবণ","ভাদ্র","আশ্বিন","কার্তিক","অগ্রহায়ণ","পৌষ","মাঘ","ফাল্গুন","চৈত্র"];
function bangabdaFromSun(J, localDate){
  const by = (localDate >= new Date(localDate.getFullYear(),3,14)) ? (localDate.getFullYear()-593) : (localDate.getFullYear()-594);
  const ay = (MODE_PARAMS[MODE].ayan()); // simple
  const lon = norm360(sunLong(J) - ay);
  const sign = Math.floor(lon/30);
  const day = Math.floor((lon%30)) + 1;
  return { month:B_MONTHS[sign], day, year:by, sunSignIdx:sign, sunLong:lon };
}

/* Ascendant approximate (simplified) */
function ascendantDeg(J, lon, lat){
  const LST = lstDeg(J, lon) * D2R;
  const eps = obliq((J-2451545)/36525) * D2R;
  // crude approximate formula
  const tanLat = Math.tan(lat*D2R);
  // use formula: tan(lambda_asc) = sin(LST)*cos(eps) - tan(lat)*sin(eps) / cos(LST)
  const num = Math.sin(LST)*Math.cos(eps) - tanLat*Math.sin(eps);
  const den = Math.cos(LST);
  let asc = Math.atan2(num, den) * R2D;
  asc = norm360(asc);
  return asc;
}

/* Moon rashi progress */
function moonRashiProgress(J){
  const sm = siderealMoonLong(J);
  const sign = Math.floor(sm/30);
  const inSignDeg = sm % 30;
  const partIndex = Math.floor(inSignDeg / 10);
  const partProgress = (inSignDeg % 10) / 10;
  return { sign, inSignDeg, partIndex, partProgress, signName: SIGN_NAMES_BN[sign] };
}

/* ---------- Festival rules (curated list) ---------- */
/*
  Each festival rule has:
    id, name_bn, source, rule: function(J_localDate) -> boolean OR returns object {when: '...' }
  We implement common Bengali/Hindu festivals with typical rules:
  (This is a curated set — not exhaustive — you can expand by adding more rules)
*/
const FESTIVAL_RULES = [
  {
    id:'pahela_baishakh',
    name_bn:'পহেলা বৈশাখ (বাংলা নববর্ষ)',
    source:'Bengali Calendar',
    rule: (ctx)=>{ // first day of Baishakh in Bangabda -> we detect month change
      return ctx.bangabda && ctx.bangabda.month==='বৈশাখ' && ctx.bangabda.day===1;
    }
  },
  {
    id:'durga_astami',
    name_bn:'মহাশষ্ঠী-মহাষ্টমী-মহা নবমী-মহাশষ্ঠী (দুর্গা আয়োজন / মূল দিনে দর্শন)',
    source:'ProKerala / Bengali',
    rule: (ctx)=>{ // Durga Puja typically: Ashwin Shukla Navami/Dashami cluster — mark 6th-10th Ashwin (approx) => easier: mark days when Bangla month is আশ্বিন and tithi is 8..10 of Shukla
      return ctx.bangabda && ctx.bangabda.month==='আশ্বিন' && ctx.tithi && ctx.tithi.num>=6 && ctx.tithi.num<=10 && ctx.tithi.paksha==='শুক্লপক্ষ';
    }
  },
  {
    id:'bijoya_dashami',
    name_bn:'বিজয়া দশমী',
    source:'Bengali',
    rule:(ctx)=>{ return ctx.bangabda && ctx.bangabda.month==='আশ্বিন' && ctx.tithi && ctx.tithi.num===10 && ctx.tithi.paksha==='শুক্লপক্ষ'; }
  },
  {
    id:'lakshmi_puja',
    name_bn:'লক্ষ্মী পূজা',
    source:'Bengali',
    rule:(ctx)=>{ // Held on Kartik or Ashwin (regional). Typical: Kartik Amavasya / Kojagari (Sharad) -> We flag when tithi=15 (Amavasya) of Kartik or specific date
      return (ctx.bangabda && ctx.bangabda.month==='কার্তিক' && ctx.tithi && ctx.tithi.num===15);
    }
  },
  {
    id:'saraswati_puja',
    name_bn:'সরস্বতী পূজা',
    source:'Bengali/ProKerala',
    rule:(ctx)=>{ // Shukla Paksha Purnima? For Saraswati often Magha/Shrawan - common: Basant Panchami -> Magh Shukla Panchami
      return (ctx.tithi && ctx.tithi.num===5 && ctx.tithi.paksha==='শুক্লপক্ষ' && ctx.bangabda && (ctx.bangabda.month==='মাঘ' || ctx.bangabda.month==='ফাল্গুন'));
    }
  },
  {
    id:'janmashtami',
    name_bn:'জন্মাষ্টমী (শ্রী কৃষ্ণ জন্ম)',
    source:'General',
    rule:(ctx)=>{ // Krishna Janmashtami: Bhadrapada Ashtami (Krishna paksha 8)
      return ctx.bangabda && ctx.bangabda.month==='ভাদ্র' && ctx.tithi && ctx.tithi.num===8 && ctx.tithi.paksha==='কৃষ্ণপক্ষ';
    }
  },
  {
    id:'ekadashi',
    name_bn:'একাদশী',
    source:'Panchika',
    rule:(ctx)=>{ return ctx.tithi && ctx.tithi.num===11; }
  },
  {
    id:'purnima',
    name_bn:'পূর্ণিমা',
    source:'Panchika',
    rule:(ctx)=>{ return ctx.tithi && ctx.tithi.num===15 && ctx.tithi.paksha==='শুক্লপক্ষ'; }
  },
  {
    id:'amavasya',
    name_bn:'অমাবস্যা',
    source:'Panchika',
    rule:(ctx)=>{ return ctx.tithi && ctx.tithi.num===15 && ctx.tithi.paksha==='কৃষ্ণপক্ষ'; }
  },
  {
    id:'akshaya_tritiya',
    name_bn:'অক্ষয় তৃতীয়া',
    source:'Bengali',
    rule:(ctx)=>{ return ctx.tithi && ctx.tithi.num===3 && ctx.tithi.paksha==='শুক্লপক্ষ' && ctx.bangabda && ctx.bangabda.month==='জ্যৈষ্ঠ'; }
  },
  {
    id:'isckon_radhashtami',
    name_bn:'রাধা ষষ্ঠী / রাধাষ্টমী (Vaishnava)',
    source:'ISKCON',
    rule:(ctx)=>{ // general: Bhadrapada Krishna / Shukla? We'll approximate: mark as any Krishna paksha 8 in Shravan/Ashwin months (user can refine)
      return ctx.tithi && ctx.tithi.num===8 && ctx.tithi.paksha==='কৃষ্ণপক্ষ' && ctx.bangabda && (ctx.bangabda.month==='ভাদ্র' || ctx.bangabda.month==='আশ্বিন' || ctx.bangabda.month==='শ্রাবণ');
    }
  },
  // Add more rules as needed. This list is extensible.
];

/* Add national & West Bengal holidays as static dates (sample; expand later) */
const STATIC_HOLIDAYS = [
  {id:'indep_day', name_bn:'স্বাধীনতা দিবস', month:8, day:15}, // Aug 15 (Gregorian)
  {id:'republic_day', name_bn:'গণতন্ত্র দিবস', month:1, day:26},
  // West Bengal state holidays (examples)
  {id:'wb_martyrs_day', name_bn:'শহীদ দিবস', month:1, day:30}
];

/* ---------- Location resolver (try geolocation, else fallback) ---------- */
async function getLocation(){
  const FALLBACK = {lat:22.5726, lon:88.3639, tz:(-new Date().getTimezoneOffset()/60), place:"Kolkata, India", city:"Kolkata", label:'Fallback'};
  if(navigator.geolocation){
    try{
      const p = await new Promise((res,rej)=> navigator.geolocation.getCurrentPosition(res,rej,{timeout:5000}));
      const lat=p.coords.latitude, lon=p.coords.longitude;
      return {lat, lon, tz:(-new Date().getTimezoneOffset()/60), place:`GPS (${lat.toFixed(2)},${lon.toFixed(2)})`, city:'GPS', label:'GPS'};
    }catch(e){}
  }
  return FALLBACK;
}

/* ---------- Calendar building & UI ---------- */

const DOM = {
  grid: document.getElementById('mbCalendarGrid'),
  monthTitle: document.getElementById('mbBanglaMonth'),
  gregSmall: document.getElementById('mbGregSmall'),
  detailTitle: document.getElementById('detailDateTitle'),
  detailPlace: document.getElementById('detailPlace'),
  detailSun: document.getElementById('detailSun'),
  detailTithi: document.getElementById('detailTithi'),
  detailPaksha: document.getElementById('detailPaksha'),
  detailNakshatra: document.getElementById('detailNakshatra'),
  detailLagna: document.getElementById('detailLagna'),
  detailFestivals: document.getElementById('detailFestivals'),
  detailRaw: document.getElementById('detailRaw'),
  prevMonth: document.getElementById('prevMonth'),
  nextMonth: document.getElementById('nextMonth'),
  todayBtn: document.getElementById('todayBtn'),
  modeSelect: document.getElementById('modeSelect'),
};

let currentView = { year: (new Date()).getFullYear(), month:(new Date()).getMonth()+1 }; // Gregorian month
let cachedPlace = null;

/* convert local JS date to JD at 0h UTC for that date */
function JD_fromLocalDate(y,m,d){ return JD(y,m,d,0); }

/* create 6x7 grid entries and populate */
function makeGrid(){
  DOM.grid.innerHTML = "";
  for(let i=0;i<42;i++){
    const cell = document.createElement('div');
    cell.className = 'mb-cell';
    cell.dataset.idx = i;
    cell.innerHTML = `<div class="bn-day-small"></div><div class="date-num"></div><div class="event-line"></div>`;
    DOM.grid.appendChild(cell);
    cell.addEventListener('click', ()=> onCellClick(i));
  }
}
makeGrid();

function onCellClick(cellIdx){
  const el = DOM.grid.children[cellIdx];
  const cellData = el._cellData;
  if(!cellData) return;
  showDayDetails(cellData);
}

/* Render calendar for given Gregorian month/year */
async function renderMonth(year, month){
  // month: 1..12
  DOM.monthTitle.textContent = "লোডিং…";
  DOM.gregSmall.textContent = `${year}-${String(month).padStart(2,'0')}`;
  // compute first day of month and weekday
  const first = new Date(year, month-1, 1);
  const startWeek = first.getDay(); // 0 Sun
  // compute days in month
  const daysInMonth = new Date(year, month, 0).getDate();

  // build 6x7 mapping
  let cells = [];
  for(let r=0;r<6;r++){
    for(let c=0;c<7;c++){
      const idx = r*7 + c;
      const dayNumber = idx - startWeek + 1;
      const inMonth = dayNumber>=1 && dayNumber<=daysInMonth;
      const gDate = inMonth ? new Date(year,month-1,dayNumber) : null;
      cells.push({ inMonth, dayNumber, gDate });
    }
  }

  // compute panchika values for in-month days (we use JD at local day)
  const loc = cachedPlace || await getLocation();
  const lat = loc.lat, lon = loc.lon, tz = loc.tz;
  DOM.detailPlace.textContent = loc.place;

  for(let i=0;i<cells.length;i++){
    const el = DOM.grid.children[i];
    const data = cells[i];
    el._cellData = null;
    el.classList.remove('inactive','highlight');
    el.querySelector('.bn-day-small').textContent = '';
    el.querySelector('.date-num').textContent = '';
    el.querySelector('.event-line').textContent = '';
    if(!data.inMonth){ el.classList.add('inactive'); continue; }
    // compute JD at 0h UTC for the local date
    const Y = data.gDate.getFullYear(), M = data.gDate.getMonth()+1, D = data.gDate.getDate();
    const J0 = JD(Y,M,D,0);
    // estimate sunrise/sunset
    const sraw = solarRiseSetUTC_raw(J0, lat, lon, (MODE_PARAMS[MODE].sun_h0||-0.833));
    const srLocal = sraw.riseUTC!=null ? sraw.riseUTC + tz : null;
    const ssLocal = sraw.setUTC!=null ? sraw.setUTC + tz : null;
    // choose a JD evaluation time near noon local for tithi/nakshatra
    const evalJD = J0 + ((12 - tz) / 24);
    const tinfo = tithiInfoAt(evalJD);
    const nidx = nakIdx(evalJD);
    const nakName = ["অশ্বিনী","ভরণী","কৃতিকা","রোহিণী","মৃগশিরা","আরুন্ধতী","পুনর্বসু","পুশ্য","আয়ুষ্মন্ত","অশু","মাঘ","ফল্গুন","চৈতাল","বৃশ্চিক","ধনূ","মকর","কুম্ভ","মীন","উৎপাত","পূর্বফাল্গুন","পূর্ব","আরো"].slice(0,27); // placeholder
    // bangabda
    const bang = bangabdaFromSun(evalJD, data.gDate);
    // assemble events via festival rules
    const ctx = { JdayUTC: J0, date: data.gDate, tithi: tinfo, nakidx:nidx, bangabda: bang };
    const todaysFests = [];
    FESTIVAL_RULES.forEach(f=>{
      try{
        if(f.rule(ctx)) todaysFests.push({id:f.id, name:f.name_bn, source:f.source});
      }catch(e){}
    });
    // static holidays by Gregorian
    STATIC_HOLIDAYS.forEach(h=>{
      if(h.month===M && h.day===D) todaysFests.push({id:h.id, name:h.name_bn, source:'Govt'});
    });
    // fill cell UI
    el._cellData = { date: data.gDate, tithi: tinfo, nakIdx:nidx, bangabda:bang, srLocal, ssLocal, festivals: todaysFests, lat, lon, evalJD, ctx };
    el.querySelector('.bn-day-small').textContent = `${bang.month}`;
    el.querySelector('.date-num').textContent = String(D);
    if(todaysFests.length) el.querySelector('.event-line').textContent = todaysFests.map(x=>x.name).slice(0,2).join(' • ');
  }

  // header
  DOM.monthTitle.textContent = `${B_MONTHS[(new Date(year,month-1,10)).getMonth()%12]} ${year}`; // approximate
  DOM.gregSmall.textContent = `${year} - ${String(month).padStart(2,'0')}`;
}

/* show details in side panel */
function showDayDetails(cellData){
  const d = cellData.date;
  DOM.detailTitle.textContent = `${d.toLocaleDateString('bn-BD',{weekday:'long', day:'numeric', month:'long', year:'numeric'})}`;
  DOM.detailSun.textContent = `সূর্যোদয়: ${fmt12(cellData.srLocal)} · সূর্যাস্ত: ${fmt12(cellData.ssLocal)}`;
  DOM.detailTithi.textContent = `${cellData.tithi.num} — (অংশ = ${cellData.tithi.angle.toFixed(1)}°)`;
  DOM.detailPaksha.textContent = `${cellData.tithi.paksha}`;
  DOM.detailNakshatra.textContent = `নক্ষত্র #${cellData.nakIdx}`;
  const asc = ascendantDeg(cellData.evalJD, cellData.lon, cellData.lat);
  DOM.detailLagna.textContent = `${SIGN_NAMES_BN[Math.floor(asc/30)]} · ${asc.toFixed(1)}°`;
  // festivals
  DOM.detailFestivals.innerHTML = '';
  if(cellData.festivals.length===0) DOM.detailFestivals.textContent = 'কোনো বিশেষ অনুষ্ঠান নেই';
  else{
    cellData.festivals.forEach(f=>{
      const div = document.createElement('div');
      div.style.padding='6px';
      div.style.borderBottom='1px dashed #eee';
      div.innerHTML = `<strong>${f.name}</strong> <small style="color:#666">(${f.source})</small>`;
      DOM.detailFestivals.appendChild(div);
    });
  }
  DOM.detailRaw.textContent = JSON.stringify(cellData,null,2);
}

/* navigation handlers */
DOM.prevMonth.addEventListener('click', ()=>{
  if(currentView.month===1){ currentView.month=12; currentView.year--; } else currentView.month--;
  renderMonth(currentView.year, currentView.month);
});
DOM.nextMonth.addEventListener('click', ()=>{
  if(currentView.month===12){ currentView.month=1; currentView.year++; } else currentView.month++;
  renderMonth(currentView.year, currentView.month);
});
DOM.todayBtn.addEventListener('click', ()=>{
  const now = new Date(); currentView.year = now.getFullYear(); currentView.month = now.getMonth()+1;
  renderMonth(currentView.year, currentView.month);
});
DOM.modeSelect.addEventListener('change', (e)=>{
  MODE = e.target.value; localStorage.setItem("madhabam_mode_v7", MODE);
  renderMonth(currentView.year, currentView.month);
});

/* Initialize */
(async function init(){
  cachedPlace = await getLocation();
  DOM.modeSelect.value = MODE;
  const now = new Date();
  currentView.year = now.getFullYear(); currentView.month = now.getMonth()+1;
  renderMonth(currentView.year, currentView.month);
  // hourly refresh
  setInterval(()=> renderMonth(currentView.year, currentView.month), 1000*60*60);
})();
  </script>

                            
