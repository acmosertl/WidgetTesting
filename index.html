<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>মাধবম — Ekadashi Engine (Pure)</title>
<style>
:root{
  --bg:#fff4e3; --panel:#fff1dd; --card:#ffffff; --muted:#7a7a7a;
  --accent:#e53935; --accent-dark:#c62828; --purple:#5e35b1;
  --seo-orange:#ff8a65; --seo-blue:#42a5f5; --seo-green:#66bb6a;
  --shadow: 0 6px 20px rgba(20,20,40,.08);
  --soft-shadow:0 4px 12px rgba(0,0,0,.06);
  --radius:14px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:"Noto Sans Bengali",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; background:var(--bg); color:#1a1a1a}
.container{max-width:980px;margin:18px auto;padding:12px}
.header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
.brand{font-weight:900;color:var(--purple);font-size:22px}
.note{color:var(--muted);font-size:13px}
.grid{display:grid;grid-template-columns:1fr 360px;gap:14px;align-items:start}
@media (max-width:920px){ .grid{grid-template-columns:1fr} .rightCol{order:2} .leftCol{order:1} }

.card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:var(--soft-shadow)}
.topCard{display:flex;flex-direction:column;gap:8px}
.topHeader{display:flex;align-items:center;justify-content:space-between;gap:8px}
.ekName{font-weight:900;font-size:26px;color:var(--accent)}
.ekMeta{font-size:13px;color:var(--muted)}
.countdown{font-size:20px;font-weight:900;color:#222}
.subline{font-size:13px;color:var(--muted)}

.infoRow{display:flex;gap:8px;flex-wrap:wrap}
.badge{background:#fff;padding:6px 10px;border-radius:999px;font-weight:800;box-shadow:var(--soft-shadow);font-size:13px}
.badge.verify{background:linear-gradient(90deg,#e8f5e9,#c8e6c9);color:#1b5e20}
.badge.isk{background:linear-gradient(90deg,#e3f2fd,#bbdefb);color:#0d47a1}

.pill{background:#fff8fb;border-radius:10px;padding:10px;box-shadow:0 2px 8px rgba(0,0,0,.03)}
.pill .label{font-weight:900;color:var(--purple);margin-bottom:6px}
.pill .value{font-weight:900;font-size:20px}

.tableWrap{margin-top:12px}
.table{width:100%;border-collapse:collapse}
.table thead th{background:#faf8ff;padding:10px;font-weight:900;color:var(--purple);text-align:left;border-top-left-radius:10px;border-top-right-radius:10px}
.table tbody tr td{padding:10px;border-top:1px solid #f1f1f1;font-size:14px}
.small{font-size:13px;color:var(--muted)}

.rightCol .card{position:sticky;top:16px}
.sideCard .title{font-weight:900;color:var(--purple);font-size:18px;margin-bottom:8px}
.sideCard .k{font-weight:900;font-size:28px;color:var(--accent)}
.sideList{margin-top:8px;display:flex;flex-direction:column;gap:8px}
.sideList .item{background:#fff;padding:10px;border-radius:10px;box-shadow:var(--soft-shadow);display:flex;justify-content:space-between;align-items:center}
.sideList .item .left{display:flex;flex-direction:column}
.sideList .item .left .l1{font-weight:900}
.sideList .item .left .l2{font-size:13px;color:var(--muted)}
.empty{opacity:.6;text-align:center;padding:24px;color:var(--muted)}

.loadBar{display:flex;align-items:center;gap:8px;color:var(--muted);font-weight:700}
.err{color:#b00020;font-weight:800}

.footer{margin-top:16px;color:var(--muted);font-size:13px;text-align:center}
.linkLike{color:var(--accent);text-decoration:underline;cursor:pointer}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand">মাধবম — একাদশী ইঞ্জিন</div>
    <div class="note">একাদশীর তালিকা: ISKCON + Local hybrid · Auto refresh · Countdown চলবে</div>
  </div>

  <div class="grid">
    <!-- LEFT: main list + top -->
    <div class="leftCol">
      <div class="card topCard" id="topCard">
        <div class="topHeader">
          <div>
            <div class="ekMeta">পরবর্তী একাদশী</div>
            <div class="ekName" id="ek-name">লোড হচ্ছে...</div>
          </div>
          <div style="text-align:right">
            <div class="countdown" id="ek-count">—</div>
            <div class="subline" id="ek-date">—</div>
          </div>
        </div>

        <div class="infoRow">
          <div class="badge" id="ek-paran">পারণ: —</div>
          <div class="badge" id="ek-source">সূত্র: —</div>
          <div class="badge" id="ek-verified">ভেরিফায়েড: —</div>
        </div>

        <div class="pill" id="ek-desc">
          <div class="label">সংক্ষিপ্ত বিবরণ</div>
          <div class="value small" id="ek-desc-text">একাদশীর বিস্তারিত এখানে দেখাবে — নাম, পারণ, ভেরিফাই ইত্যাদি।</div>
        </div>

        <div style="margin-top:12px" class="small">
          <span id="last-updated">Last updated: —</span>
          <span style="float:right"><span class="linkLike" id="refresh-now">Refresh now</span></span>
        </div>
      </div>

      <div class="card tableWrap" style="margin-top:12px">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div style="font-weight:900;color:var(--purple)">বার্ষিক একাদশী তালিকা (২৪)</div>
          <div class="loadBar" id="list-status">লোড হচ্ছে…</div>
        </div>

        <div style="margin-top:12px;overflow:auto">
          <table class="table" id="ek-table">
            <thead>
              <tr><th>একাদশী</th><th>তারিখ</th><th>পারণ</th><th class="small">ভেরিফাই</th></tr>
            </thead>
            <tbody id="ek-tbody">
              <tr><td colspan="4" class="empty">তালিকা এখনও লোড হয়নি</td></tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>

    <!-- RIGHT: side panel (current card + counter list) -->
    <div class="rightCol">
      <div class="card sideCard">
        <div class="title">বর্তমান একাদশী (কার্ড)</div>
        <div style="display:flex;gap:10px;align-items:center">
          <div style="flex:1">
            <div class="small">নাম</div>
            <div class="k" id="side-name">—</div>
            <div class="small" id="side-date">—</div>
          </div>
          <div style="width:110px;text-align:right">
            <div class="small">দিন</div>
            <div class="k" id="side-remaining">—</div>
          </div>
        </div>

        <div class="sideList" id="side-list" style="margin-top:12px">
          <div class="item"><div class="left"><div class="l1">লোডিং...</div><div class="l2">তালিকা আসছে</div></div><div></div></div>
        </div>

        <div style="margin-top:12px" class="small">নোট: কাউন্টার সরাসরি ব্রাউজারে চলবে; পেজ রিফ্রেশ দরকার নেই।</div>
      </div>
    </div>
  </div>

  <div class="footer">এই পেজটি একাদশী-engine; ডেটা সোর্স: <span id="src-text" class="small">/api/ekadashi</span></div>
</div>

<script>
/* =========================
   CONFIG — শুধু এখানে সেট করো
   ========================= */
const LOCAL_JSON = "/api/ekadashi"; // ✅ তোমার ekadashi JSON route
const AUTO_REFRESH_MS = 1000 * 60 * 60 * 3; // 3 hours silent refresh
const COUNTER_TICK_MS = 1000; // countdown tick

/* ===== utility ===== */
const $ = sel => document.querySelector(sel);
const fmtDate = iso => {
  try{
    const d = new Date(iso);
    if(isNaN(d)) return iso;
    return d.toLocaleDateString('bn-BD',{year:'numeric',month:'long',day:'numeric'});
  }catch(e){ return iso; }
};
function prettyTimeRemaining(ms){
  if(ms<=0) return "0s";
  const s = Math.floor(ms/1000);
  const days = Math.floor(s/86400); const hh = Math.floor((s%86400)/3600);
  const mm = Math.floor((s%3600)/60); const sec = s%60;
  if(days>0) return `${days} দিন ${hh} ঘন্টা`;
  if(hh>0) return `${hh}ঘ ${mm}মি`;
  if(mm>0) return `${mm}মি ${sec}সেক`;
  return `${sec}সেক`;
}

/* ===== app state ===== */
let ekList = []; // array from JSON (objects)
let currentEk = null;
let lastFetchedAt = null;
let countdownTimer = null;
let tickInterval = null;

/* ===== render helpers ===== */
function renderTop(next){
  if(!next){
    $('#ek-name').textContent = "লোড হচ্ছে...";
    $('#ek-count').textContent = "—";
    $('#ek-date').textContent = "—";
    $('#ek-paran').textContent = "পারণ: —";
    $('#ek-source').textContent = "সূত্র: —";
    $('#ek-verified').textContent = "ভেরিফায়েড: —";
    $('#ek-desc-text').textContent = "তথ্য পাওয়া যায়নি।";
    return;
  }
  $('#ek-name').textContent = next.name || next.name_bn || next.title || "নাম নেই";
  $('#ek-date').textContent = (next.date || next.date_iso || next.dateISO) ? fmtDate(next.date || next.date_iso || next.dateISO) : "—";
  $('#ek-paran').textContent = "পারণ: " + (next.paran || next.parana || next.paran_text || next.parana_bn || "—");
  $('#ek-source').textContent = "সূত্র: " + (next.source || next.from || "Local");
  $('#ek-verified').textContent = "ভেরিফায়েড: " + (next.verified || "—");
  $('#ek-desc-text').textContent = (next.notes || next.desc || next.paran_note || "").toString() || "—";
  currentEk = next;
}

function renderList(list){
  const tbody = $('#ek-tbody');
  tbody.innerHTML = '';
  if(!list || !list.length){
    tbody.innerHTML = `<tr><td colspan="4" class="empty">কোনও একাদশী পাওয়া যায়নি</td></tr>`; return;
  }
  list.forEach(it=>{
    const name = it.name || it.name_bn || it.title || '';
    const date = it.date || it.date_iso || it.dateISO || it.date_en || '';
    const paran = it.paran || it.parana || it.paran_text || it.parana_bn || '';
    const verified = it.verified || it.source || '';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><strong>${name}</strong><div class="small">${it.paksha||''} ${it.note?('· '+it.note):''}</div></td>
      <td>${fmtDate(date)}</td>
      <td class="small">${paran || '—'}</td>
      <td class="small">${verified || '—'}</td>`;
    tbody.appendChild(tr);
  });
}

function renderSide(current, list){
  $('#side-name').textContent = current? (current.name || current.name_bn || current.title) : '—';
  $('#side-date').textContent = current? (current.date || current.date_iso || current.dateISO || '') : '—';
  $('#side-remaining').textContent = current? computeDaysRemainingText(current) : '—';

  const sideList = $('#side-list');
  sideList.innerHTML = '';
  if(!list || !list.length){
    sideList.innerHTML = `<div class="item"><div class="left"><div class="l1">তালিকা খালি</div><div class="l2">কোনও ডেটা নেই</div></div></div>`;
    return;
  }
  // show next 6 upcoming as small counters
  const now = Date.now();
  const upcoming = list.slice(0,24);
  upcoming.forEach(it=>{
    const dt = new Date(it.date || it.date_iso || it.dateISO || it.date_en || it.date).getTime();
    const remMs = (isNaN(dt)?0:(dt - now));
    const leftText = remMs>0? prettyTimeRemaining(remMs):"পাস হয়েছে";
    const el = document.createElement('div');
    el.className = 'item';
    el.innerHTML = `<div class="left"><div class="l1">${it.name||it.name_bn||it.title}</div><div class="l2">${fmtDate(it.date||it.date_iso||it.dateISO||it.date_en||it.date)}</div></div><div class="right small">${leftText}</div>`;
    sideList.appendChild(el);
  });
}

/* ===== business logic ===== */
function computeNextEk(list){
  if(!Array.isArray(list) || list.length===0) return null;
  // ensure sorted by date ascending
  const sorted = list.slice().sort((a,b)=>{
    const da = new Date(a.date||a.date_iso||a.dateISO||a.date_en).getTime();
    const db = new Date(b.date||b.date_iso||b.dateISO||b.date_en).getTime();
    return (isNaN(da)?1:da) - (isNaN(db)?1:db);
  });
  const now = Date.now();
  // find first date >= today (use midnight comparison)
  for(let i=0;i<sorted.length;i++){
    const it = sorted[i];
    const d = new Date(it.date||it.date_iso||it.dateISO||it.date_en);
    if(isNaN(d)) continue;
    // consider it upcoming if date at 00:00 local is >= today at 00:00
    const today = new Date(); today.setHours(0,0,0,0);
    d.setHours(0,0,0,0);
    if(d.getTime() >= today.getTime()){
      return {next:sorted[i], list:sorted};
    }
  }
  // fall back to first
  return {next:sorted[0], list:sorted};
}

function computeDaysRemainingText(item){
  if(!item) return '—';
  const dt = new Date(item.date || item.date_iso || item.dateISO || item.date_en).getTime();
  if(isNaN(dt)) return '—';
  const now = Date.now();
  const ms = dt - now;
  if(ms<=0) return 'আজ';
  const d = Math.floor(ms/(1000*60*60*24));
  return d>0? `${d} দিন` : 'কম';
}

/* countdown loop */
function startCountdownFor(item){
  if(!item) { $('#ek-count').textContent = '—'; return; }
  if(tickInterval) clearInterval(tickInterval);
  tickInterval = setInterval(()=>{
    const dt = new Date(item.date || item.date_iso || item.dateISO || item.date_en).getTime();
    const rem = dt - Date.now();
    if(rem <= 0){
      // if passed, fetch again immediately to shift to next
      $('#ek-count').textContent = "শুরু হচ্ছে...";
      fetchAndRender(true);
      return;
    }
    $('#ek-count').textContent = prettyTimeRemaining(rem);
    $('#side-remaining').textContent = prettyTimeRemaining(rem);
  }, COUNTER_TICK_MS);
}

/* fetch + render */
async function fetchEk(silent=false){
  try{
    if(!silent) $('#list-status').textContent = 'লোড করছে…';
    const res = await fetch(LOCAL_JSON, {cache:'no-store'});
    if(!res.ok) throw new Error('Fetch failed: '+res.status);
    const j = await res.json();
    // expected shape: { ekadashi_list: [...] } or array directly
    let list = [];
    if(Array.isArray(j)) list = j;
    else if(Array.isArray(j.ekadashi_list)) list = j.ekadashi_list;
    else if(Array.isArray(j.data)) list = j.data;
    else {
      // try keys
      const maybe = Object.values(j).find(v=>Array.isArray(v));
      if(Array.isArray(maybe)) list = maybe;
    }
    lastFetchedAt = new Date();
    return {ok:true, list, raw:j};
  }catch(err){
    console.error("Fetch error:", err);
    return {ok:false, err};
  } finally {
    if(!silent) $('#list-status').textContent = '';
  }
}

async function fetchAndRender(silent=false){
  const r = await fetchEk(silent);
  if(!r.ok){
    if(!silent) {
      $('#list-status').innerHTML = `<span class="err">ডেটা লোড হয়নি</span>`;
      setTimeout(()=>{ $('#list-status').textContent='লোড হয়েছে'; }, 2000);
    }
    return;
  }
  ekList = r.list || [];
  // sort by date
  ekList.sort((a,b)=>{
    const da = new Date(a.date || a.date_iso || a.dateISO || a.date_en).getTime() || Infinity;
    const db = new Date(b.date || b.date_iso || b.dateISO || b.date_en).getTime() || Infinity;
    return da - db;
  });

  // render table and top
  renderList(ekList);

  const {next, list} = computeNextEk(ekList);
  renderTop(next);
  renderSide(next, list);

  // last updated stamp
  $('#last-updated').textContent = 'Last updated: ' + (lastFetchedAt? lastFetchedAt.toLocaleString(): new Date().toLocaleString());

  // start countdown for next
  startCountdownFor(next);
}

/* init */
(async function init(){
  // show immediate local UI
  $('#list-status').textContent = 'লোড হচ্ছে…';
  // initial fetch
  await fetchAndRender(false);

  // silent auto refresh every 3 hours
  setInterval(()=>fetchAndRender(true), AUTO_REFRESH_MS);

  // refresh-now button
  $('#refresh-now').onclick = ()=>{ fetchAndRender(false); };

  // also refresh when visibility regained (useful if user opened tab)
  document.addEventListener('visibilitychange', ()=>{
    if(document.visibilityState === 'visible'){
      fetchAndRender(true);
    }
  });

  // ensure side list updates every minute for nicer countdown text (less frequent)
  setInterval(()=>{
    // re-render side small timers
    if(ekList && ekList.length){
      const {next,list} = computeNextEk(ekList);
      renderSide(next, list);
    }
  }, 60*1000);

})();
</script>
</body>
</html>
