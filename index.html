<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>üå∏ ‡¶Æ‡¶æ‡¶ß‡¶¨‡¶Æ ‡¶è‡¶ï‡¶æ‡¶¶‡¶∂‡ßÄ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ v5.2 (IST Core)</title>
<style>
:root{
  --red1:#C62828; --red2:#D32F2F; --gold:#FFD54F; --cream:#FFF8E1;
  --txt:#ffffff; --shadow:0 10px 24px rgba(0,0,0,.18);
}
*{box-sizing:border-box}
body{margin:0;background:#fff4e3;font-family:"Noto Sans Bengali",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
.wrap{max-width:460px;margin:18px auto;padding:12px}
.card{
  background:linear-gradient(180deg,var(--red1),var(--red2));
  color:var(--txt); border-radius:20px; padding:18px; box-shadow:var(--shadow);
}
.title{margin:0 0 8px 0;font-weight:900;font-size:20px;text-align:center}
.name{font-size:30px;font-weight:900;letter-spacing:.3px;text-align:center;
  color:var(--gold); text-shadow:0 0 14px rgba(255,213,79,.7),0 0 28px rgba(255,213,79,.35)}
.meta{font-size:16px;font-weight:700;text-align:center;margin-top:6px}
.paran{font-size:15px;text-align:center;margin-top:6px}
.tick{display:inline-block;margin-left:6px;font-weight:900;color:#52ff8f}
.loc{font-size:13px;opacity:.95;text-align:center;margin-top:8px}
.btn{
  display:block;margin:12px auto 0 auto;background:linear-gradient(90deg,#FBC02D,#F57C00);
  color:#4E342E;font-weight:800;border:none;border-radius:14px;padding:10px 16px;
  box-shadow:0 6px 16px rgba(0,0,0,.12); cursor:pointer; transition:.25s;
}
.btn:hover{box-shadow:0 0 16px rgba(255,215,64,.65)}
.note{font-size:12px;text-align:center;color:#5d4037;margin-top:8px}

/* Popup */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(4px);z-index:99}
.box{background:var(--cream);width:min(92vw,560px);margin:8% auto;border-radius:18px;box-shadow:var(--shadow);max-height:80vh;display:flex;flex-direction:column}
.head{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-bottom:1px solid rgba(0,0,0,.08)}
.head h3{margin:0;font-size:18px;color:#8E24AA;font-family:"Him","Noto Sans Bengali",system-ui}
.close{font-weight:900;color:#C62828;cursor:pointer;font-size:18px}
.body{padding:8px 12px;overflow:auto}
.table{width:100%;border-collapse:collapse}
.table th{position:sticky;top:0;background:#F3E5F5;color:#6A1B9A;font-weight:900;font-size:13px;padding:8px;text-align:center}
.table td{padding:8px;border-bottom:1px solid rgba(0,0,0,.08);font-size:14px;text-align:center}
.tr-cur{background:#FFF3E0;outline:2px solid #FBC02D}
.badge{display:inline-block;font-size:11px;padding:2px 6px;border-radius:10px;background:#ffe082;color:#5d4037;margin-left:6px}
.skel{opacity:.6;filter:grayscale(1)}
.small{font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <section class="card" id="ekaCard">
    <h2 class="title">üå∏ ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶è‡¶ï‡¶æ‡¶¶‡¶∂‡ßÄ</h2>
    <div class="name" id="ekaName">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá‚Ä¶</div>
    <div class="meta" id="ekaDate">‚Äî</div>
    <div class="meta" id="ekaLeft">‚Äî</div>
    <div class="paran" id="ekaParan" style="display:none">‚Äî</div>
    <div class="loc" id="ekaLoc">üìç ‡¶ï‡¶≤‡¶ï‡¶æ‡¶§‡¶æ (IST)</div>
    <button class="btn" id="openList">üîî ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶è‡¶ï‡¶æ‡¶¶‡¶∂‡ßÄ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
    <div class="note small">‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶ó‡¶£‡¶®‡¶æ ‡¶≠‡¶æ‡¶∞‡¶§‡ßÄ‡¶Ø‡¶º ‡¶Æ‡¶æ‡¶® ‡¶∏‡¶Æ‡¶Ø‡¶º (IST, UTC+05:30) ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ‡•§</div>
  </section>
</div>

<!-- Popup: Annual List -->
<div class="modal" id="listModal">
  <div class="box">
    <div class="head">
      <h3>üå∏ ‡¶¨‡¶æ‡¶∞‡ßç‡¶∑‡¶ø‡¶ï ‡¶è‡¶ï‡¶æ‡¶¶‡¶∂‡ßÄ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ (IST)</h3>
      <span class="close" id="closeList">‚úñ</span>
    </div>
    <div class="body">
      <table class="table" id="ekaTable">
        <thead><tr><th>‡¶è‡¶ï‡¶æ‡¶¶‡¶∂‡ßÄ</th><th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th><th>‡¶™‡¶æ‡¶∞‡¶£</th></tr></thead>
        <tbody id="ekaTbody"></tbody>
      </table>
      <div class="note">‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶∏‡¶Æ‡ßü IST ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï‡•§ ‡¶™‡¶æ‡¶∞‡¶£ ‡¶∏‡¶Æ‡ßü ‡¶ï‡ßá‡¶¨‡¶≤ ‡¶§‡¶ñ‡¶®‡¶á ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡ßü ‡¶Ø‡¶ñ‡¶® ‡¶â‡ßé‡¶∏‡ßá ‡¶â‡¶≤‡ßç‡¶≤‡ßá‡¶ñ ‡¶•‡¶æ‡¶ï‡ßá; ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‚Äú‡¶™‡¶∞‡ßá‡¶∞ ‡¶¶‡¶ø‡¶®‚Äù ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡ßü‡•§</div>
    </div>
  </div>
</div>

<script>
/* =========================================================
   MƒÅdhabam EkƒÅda≈õƒ´ Calendar v5.2 ‚Äî IST Core + Global Offset
   Single-file (GitHub + Vercel ready). No server needed.
   Data Strategy:
   1) Try direct ISKCON JSON (may be CORS locked)
   2) Try r.jina.ai relay (CORS-friendly mirror)
   3) Fallback to embedded minimal list (no parana)
   ========================================================= */

// ---------- CONFIG ----------
const REGION = "kolkata";          // IST core
const MAX_EVENTS = 50;             // pull enough to cover ~1 year
// Candidate sources (adjustable later if you have a better JSON URL)
const SOURCES = [
  `https://iskcon.today/api/calendar?region=${REGION}&limit=${MAX_EVENTS}`,
  // CORS-friendly read-through (tries to fetch the above even if CORS-locked)
  `https://r.jina.ai/http://iskcon.today/api/calendar?region=${REGION}&limit=${MAX_EVENTS}`,
  `https://r.jina.ai/https://iskcon.today/api/calendar?region=${REGION}&limit=${MAX_EVENTS}`
];

// ---- Minimal embedded fallback (only if all remote fail) ----
const FALLBACK = [
  // NOTE: Only for emergency UI; no parana => no tick ‚úì
  // You can safely deploy; once remote works, this won't be used.
  {"name":"‡¶â‡¶§‡ßç‡¶•‡¶æ‡¶® ‡¶è‡¶ï‡¶æ‡¶¶‡¶∂‡ßÄ","date":"2025-11-30"},
  {"name":"‡¶Æ‡ßã‡¶ï‡ßç‡¶∑‡¶¶‡¶æ ‡¶è‡¶ï‡¶æ‡¶¶‡¶∂‡ßÄ","date":"2025-12-14"},
  {"name":"‡¶∏‡¶æ‡¶´‡¶≤‡¶æ ‡¶è‡¶ï‡¶æ‡¶¶‡¶∂‡ßÄ","date":"2026-01-10"}
];

// ---------- Utilities ----------
const IST_OFFSET_MIN = 330; // minutes
function toIST(dUtc){
  // Return a Date representing same timestamp, but helpers below use display in bn-IN locale.
  return new Date(dUtc.getTime() + (IST_OFFSET_MIN - dUtc.getTimezoneOffset())*60000);
}
function fmtDateBn(dateStr){
  const d = new Date(dateStr);
  return d.toLocaleDateString('bn-IN',{year:'numeric',month:'long',day:'numeric',weekday:'long'});
}
function daysLeftFromTodayIST(targetISO){
  const nowUtc = new Date();
  const nowIST = toIST(nowUtc);
  const startOfTodayIST = new Date(nowIST); startOfTodayIST.setHours(0,0,0,0);
  const target = new Date(targetISO+"T00:00:00+05:30");
  const diff = Math.ceil((target - startOfTodayIST)/86400000);
  return diff;
}
function hasParanaString(s){
  if(!s) return false;
  // Detect something like "7:45 AM ‚Äì 10:15 AM", "07:02‚Äì08:38 AM", etc.
  return /([0-9]{1,2}:[0-9]{2}\s?(AM|PM))\s*[‚Äì-]\s*([0-9]{1,2}:[0-9]{2}\s?(AM|PM))/i.test(s);
}
function istNext5amDelay(){
  // schedule refresh at next 05:00 IST
  const nowUtc = new Date();
  // Current IST:
  const nowIST = toIST(nowUtc);
  const nextIST = new Date(nowIST);
  nextIST.setDate(nowIST.getDate() + 1);
  nextIST.setHours(5,0,0,0);
  // Convert to UTC diff:
  const diffMs = nextIST - nowIST;
  return diffMs;
}
function localOffsetVsIST(){
  const now = new Date();
  const localOffsetMin = -now.getTimezoneOffset(); // minutes from UTC
  const diffMin = localOffsetMin - IST_OFFSET_MIN; // local - IST
  if(diffMin === 0) return "IST";
  const sign = diffMin > 0 ? "+" : "‚Äì";
  const absm = Math.abs(diffMin);
  const hh = Math.floor(absm/60).toString().padStart(2,'0');
  const mm = (absm%60).toString().padStart(2,'0');
  return `IST ${sign} ${hh}:${mm}`;
}
function getLocalTZName(){
  try{ return Intl.DateTimeFormat().resolvedOptions().timeZone || "Asia/Kolkata"; }
  catch(e){ return "Asia/Kolkata"; }
}

// ---------- Data fetch ----------
async function fetchEkadashiRaw(){
  for(const url of SOURCES){
    try{
      const res = await fetch(url, {cache:'no-store'});
      if(!res.ok) continue;
      const txt = await res.text();
      // Some mirrors return JSON with text/plain; parse safely
      const data = JSON.parse(txt);
      if(data && (data.events || Array.isArray(data))){
        return data.events || data;
      }
    }catch(e){ /* try next */ }
  }
  // All failed ‚Üí fallback
  return FALLBACK;
}

function normalizeEvents(list){
  // Expect objects possibly shaped like:
  // { name, name_bn, date, paran/parana, type }
  const out = [];
  const ekakey = (s)=> (s||"").toLowerCase().replace("ekƒÅda≈õƒ´","ekadasi");
  for(const e of list){
    const typ = (e.type||"").toLowerCase();
    const nm  = (e.name_bn || e.name || "").trim();
    const dt  = (e.date || e.iso || e.start || "").slice(0,10);
    if(!dt) continue;
    // Filter: only Ekadashi
    const isEka = typ.includes("ekadasi") || ekakey(nm).includes("ekadasi") || nm.includes("‡¶è‡¶ï‡¶æ‡¶¶‡¶∂‡ßÄ");
    if(!isEka) continue;
    out.push({
      name: nm || "‡¶è‡¶ï‡¶æ‡¶¶‡¶∂‡ßÄ",
      date: dt,
      parana: (e.paran || e.parana || e.parana_time || e.paranaTime || "").trim()
    });
  }
  // Deduplicate + sort ascending
  out.sort((a,b)=> new Date(a.date)-new Date(b.date));
  const uniq = [];
  const seen = new Set();
  for(const x of out){
    const key = x.name+"|"+x.date;
    if(!seen.has(key)){ uniq.push(x); seen.add(key); }
  }
  // Trim around one year/24 items if long:
  return uniq.slice(0, 24);
}

// ---------- Render ----------
async function boot(){
  const locEl = document.getElementById('ekaLoc');
  // Location line: show IST core vs global offset for non-India
  const tz = getLocalTZName();
  if(/^(Asia\/Kolkata|Asia\/Calcutta)$/i.test(tz)){
    locEl.textContent = "üìç ‡¶≠‡¶æ‡¶∞‡¶§ ‚Ä¢ IST (UTC+05:30)";
  }else{
    locEl.textContent = `üìç ${tz} ‚Ä¢ Local Time: ${localOffsetVsIST()}`;
  }

  const raw = await fetchEkadashiRaw();
  const ekas = normalizeEvents(raw);

  if(!ekas.length){
    // Hard fail
    document.getElementById('ekaName').textContent = "‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶°‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá";
    document.getElementById('ekaDate').textContent = "‡¶™‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®";
    document.getElementById('ekaLeft').textContent = "‚Äî";
    scheduleSunriseRefresh();
    return;
  }

  // Find current/next by IST day boundary
  const todayUtc = new Date();
  const todayIST = toIST(todayUtc); todayIST.setHours(0,0,0,0);
  let show = null;
  for(const e of ekas){
    const d = new Date(e.date+"T00:00:00+05:30");
    if(d >= todayIST){ show = e; break; }
  }
  if(!show) show = ekas[ekas.length-1];

  // Fill main card
  const left = daysLeftFromTodayIST(show.date);
  document.getElementById('ekaName').textContent = show.name;
  document.getElementById('ekaDate').textContent = "üìÖ " + fmtDateBn(show.date);
  document.getElementById('ekaLeft').textContent = left<=0 ? "‡¶Ü‡¶ú ‡¶è‡¶ï‡¶æ‡¶¶‡¶∂‡ßÄ üå∏" : `${left} ‡¶¶‡¶ø‡¶® ‡¶¨‡¶æ‡¶ï‡¶ø`;

  const parEl = document.getElementById('ekaParan');
  if(hasParanaString(show.parana)){
    parEl.style.display = 'block';
    parEl.innerHTML = `‡¶™‡¶æ‡¶∞‡¶£: ${show.parana} <span class="badge">‡¶¶‡ßç‡¶¨‡¶æ‡¶¶‡¶∂‡ßÄ, ‡¶™‡¶∞‡ßá‡¶∞ ‡¶¶‡¶ø‡¶®</span><span class="tick">‚úì</span>`;
  }else{
    parEl.style.display = 'none';
    parEl.textContent = "";
  }

  // Build annual popup table (24 rows max)
  const tb = document.getElementById('ekaTbody');
  tb.innerHTML = "";
  for(const e of ekas){
    const isCur = (e.date === show.date);
    const parText = hasParanaString(e.parana) ? `${e.parana} (‡¶™‡¶∞‡ßá‡¶∞ ‡¶¶‡¶ø‡¶®)` : "‡¶™‡¶∞‡ßá‡¶∞ ‡¶¶‡¶ø‡¶®";
    const tr = document.createElement('tr');
    if(isCur) tr.className = "tr-cur";
    tr.innerHTML = `<td>${e.name}</td><td>${fmtDateBn(e.date)}</td><td>${parText}</td>`;
    tb.appendChild(tr);
  }

  scheduleSunriseRefresh();
}

function scheduleSunriseRefresh(){
  const delay = Math.max(istNext5amDelay(), 30_000); // safety min 30s
  setTimeout(()=>boot(), delay);
}

// Popup control
const listModal = document.getElementById('listModal');
document.getElementById('openList').onclick = ()=>{ listModal.style.display='block'; };
document.getElementById('closeList').onclick = ()=>{ listModal.style.display='none'; };
window.addEventListener('click', (e)=>{
  if(e.target === listModal) listModal.style.display='none';
});

// Start
boot();
</script>
</body>
</html>
