<!doctype html>
<html lang="bn">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>‡¶Æ‡¶æ‡¶ß‡¶¨‡¶Æ ‡¶è‡¶ï‡¶æ‡¶¶‡¶∂‡ßÄ ‚Äî ‡¶ï‡¶æ‡¶∞‡ßç‡¶° + ‡¶¨‡¶æ‡¶∞‡ßç‡¶∑‡¶ø‡¶ï ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</title>
<style>
  :root{
    --bg:#fff6e8; --card:#d22f2f; --text:#ffffff; --ink:#2b1e16;
    --pill:#ffe6a7; --shadow:0 12px 30px rgba(0,0,0,.12);
    --accent:#8b5cf6; --ok:#22c55e;
  }
  body{margin:0;background:var(--bg);font-family: Noto Sans Bengali, system-ui, -apple-system, Segoe UI, Roboto, Arial; color:var(--ink)}
  .wrap{max-width:880px;margin:24px auto;padding:16px}
  .card{background:#fff;border-radius:20px;box-shadow:var(--shadow);padding:18px}
  .ek-hero{background:var(--card);color:var(--text);border-radius:28px;padding:28px 22px;margin-top:12px}
  .chip{display:inline-flex;gap:10px;align-items:center;background:var(--pill);color:#5b3a00;border-radius:999px;padding:6px 12px;font-weight:700}
  .h1{font-weight:900;font-size:34px;letter-spacing:.5px;margin:6px 0 10px}
  .h2{font-weight:800;font-size:24px;margin:0}
  .big{font-size:44px;font-weight:900;letter-spacing:1px;text-shadow:0 8px 30px rgba(0,0,0,.25)}
  .meta{opacity:.9;margin-top:10px;font-size:18px;line-height:1.45}
  .btn{display:inline-block;border:none;border-radius:16px;padding:14px 18px;font-weight:800;cursor:pointer;box-shadow:var(--shadow)}
  .btn-grad{background:linear-gradient(135deg,#ffcc66,#ff9a3c);color:#412500}
  .note{opacity:.7;font-size:14px;margin-top:12px}
  .tick{display:none;color:var(--ok);font-weight:900;margin-left:6px}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:680px){.grid{grid-template-columns: 1fr 1fr}}
  table{width:100%;border-collapse:collapse;background:#fff;border-radius:16px;overflow:hidden}
  thead th{background:#f3e8ff;color:#4c1d95;padding:12px 10px;text-align:left}
  tbody td{padding:12px 10px;border-bottom:1px solid #f1efe9}
  .center{text-align:center}
  /* popup */
  dialog{border:none;border-radius:24px;max-width:520px;width:min(92vw,520px);padding:0}
  dialog::backdrop{backdrop-filter: blur(9px) brightness(.9)}
  .pop-head{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid #f1efe9}
  .pop-body{padding:10px 16px 18px}
  .x{width:34px;height:34px;border-radius:50%;border:0;background:#ffede1;cursor:pointer;font-size:18px}
  /* badges */
  .badge{display:inline-flex;gap:8px;align-items:center;padding:4px 10px;border-radius:999px;background:#fff;box-shadow:var(--shadow)}
  .small{font-size:13px;opacity:.85}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="grid">
      <div>
        <div class="badge small" id="tzBadge">IST ‚Ä¢ UTC+05:30</div>
        <div class="ek-hero">
          <div class="chip">üå∏ ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶è‡¶ï‡¶æ‡¶¶‡¶∂‡ßÄ</div>
          <div style="margin-top:10px">
            <div class="big" id="ekName">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá‚Ä¶</div>
            <div class="h2"><span id="ekDate">‚Äî</span> ‚Ä¢ <span id="ddays">‚Äî</span> ‡¶¶‡¶ø‡¶® ‡¶¨‡¶æ‡¶ï‡¶ø</div>
            <div class="meta" id="paranaBox">‡¶™‡¶æ‡¶∞‡¶£: <span id="ekParana">‚Äî</span> <span class="tick" id="vTick">‚úî</span></div>
            <div class="meta small" id="sourceTag" style="margin-top:6px;opacity:.8">‡¶∏‡ßã‡¶∞‡ßç‡¶∏: ‚Äî</div>
          </div>
        </div>
        <div style="margin-top:14px">
          <button class="btn btn-grad" id="openList">üîî ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶è‡¶ï‡¶æ‡¶¶‡¶∂‡ßÄ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
          <div class="note">‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶ó‡¶£‡¶®‡¶æ ‡¶≠‡¶æ‡¶∞‡¶§‡ßÄ‡¶Ø‡¶º ‡¶Æ‡¶æ‡¶® ‡¶∏‡¶Æ‡¶Ø‡¶º (IST) ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ‡•§</div>
        </div>
      </div>
      <div>
        <div class="card" style="height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center">
          <div class="h2" style="margin-bottom:6px">‡¶è‡¶ñ‡¶æ‡¶® ‡¶•‡ßá‡¶ï‡ßá‡¶á ‡¶∏‡¶æ‡¶á‡¶°-‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®</div>
          <div class="small center" style="max-width:360px;opacity:.8">
            ‡¶è‡¶á ‡¶™‡ßá‡¶ú‡¶ü‡¶ø‡¶á iFrame ‡¶ï‡¶∞‡ßá Blogger ‡¶∏‡¶æ‡¶á‡¶°-‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶¶‡¶ø‡¶®‡•§ ‡¶è‡¶ï‡¶á ‡¶∏‡ßã‡¶∞‡ßç‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡¶æ‡¶∞‡ßç‡¶°+‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ‚Äî‡¶¶‡ßÅ‡¶ü‡ßã‡¶á ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶¨‡ßá‡•§
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Annual list (inline preview for page readers) -->
  <div class="card" style="margin-top:18px">
    <div class="h2" style="color:#5b21b6;margin-bottom:8px">üå∏ ‡¶¨‡¶æ‡¶∞‡ßç‡¶∑‡¶ø‡¶ï ‡¶è‡¶ï‡¶æ‡¶¶‡¶∂‡ßÄ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ (IST)</div>
    <div class="small" style="opacity:.8;margin-bottom:10px">‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡ßç‡¶¨‡¶Ø‡¶º‡¶Ç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶Ø‡¶º (ISKCON + Madhavam PanjikƒÅ Hybrid)</div>
    <div style="overflow:auto">
      <table>
        <thead><tr><th>‡¶è‡¶ï‡¶æ‡¶¶‡¶∂‡ßÄ</th><th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th><th>‡¶™‡¶æ‡¶∞‡¶£</th></tr></thead>
        <tbody id="tblBody"><tr><td colspan="3" class="center">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá‚Ä¶</td></tr></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Popup -->
<dialog id="popup">
  <div class="pop-head">
    <div class="h2" style="color:#5b21b6;font-size:20px">üå∏ ‡¶¨‡¶æ‡¶∞‡ßç‡¶∑‡¶ø‡¶ï ‡¶è‡¶ï‡¶æ‡¶¶‡¶∂‡ßÄ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ (IST)</div>
    <button class="x" id="closePop">‚úï</button>
  </div>
  <div class="pop-body">
    <div class="small" style="opacity:.8;margin:2px 0 10px">‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡ßç‡¶¨‡¶Ø‡¶º‡¶Ç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶Ø‡¶º (ISKCON + Madhavam PanjikƒÅ Hybrid)</div>
    <div style="overflow:auto;max-height:58vh">
      <table>
        <thead><tr><th>‡¶è‡¶ï‡¶æ‡¶¶‡¶∂‡ßÄ</th><th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th><th>‡¶™‡¶æ‡¶∞‡¶£</th></tr></thead>
        <tbody id="tblBodyPop"><tr><td colspan="3" class="center">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá‚Ä¶</td></tr></tbody>
      </table>
    </div>
  </div>
</dialog>

<script>
/* =========================
   CONFIG ‚Äî ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶§‡¶ø‡¶®‡¶ü‡¶æ ‡¶ú‡¶ø‡¶®‡¶ø‡¶∏ ‡¶¨‡¶∏‡¶æ‡¶®
   ========================= */
/* CONFIG (‡¶è‡¶ó‡ßÅ‡¶≤‡ßã ‡¶è‡¶ï‡¶¨‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶≤‡ßá ‡¶Ü‡¶∞ ‡¶ï‡¶ø‡¶õ‡ßÅ‡¶á ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá ‡¶®‡¶æ) */
const ISKCON_URL  = "https://calendar-api.iskcondesiretree.com/api/v1/ekadasi?place=kolkata";
const PANJIKA_BASE = "https://madhavam-surya-siddhanto-panjika.vercel.app";
const LOCAL_JSON = "https://madhabam-ekadashi.vercel.app/api/ekadashi";

  /* ===== Fetch and Render Ekadashi Data ===== */

async function loadEkadashiData() {
  try {
    console.log("üîç Trying to fetch data from:", LOCAL_JSON);
    const res = await fetch(LOCAL_JSON);
    if (!res.ok) throw new Error("Fetch failed");
    const data = await res.json();
    const list = data.ekadashi_list;

    // Sort by date
    const sorted = list.sort((a, b) => new Date(a.date) - new Date(b.date));

    // Find next Ekadashi
    const now = new Date();
    const next = sorted.find(e => new Date(e.date) >= now);
    const remain = Math.ceil((new Date(next.date) - now) / (1000 * 60 * 60 * 24));

    // Card section
    document.querySelector(".ekadashi-name").innerText = next.name;
    document.querySelector(".ekadashi-date").innerText = next.date;
    document.querySelector(".ekadashi-remaining").innerText = remain + " ‡¶¶‡¶ø‡¶® ‡¶¨‡¶æ‡¶ï‡¶ø";
    document.querySelector(".ekadashi-paran").innerText =
      `‡¶™‡¶æ‡¶∞‡¶£: ‡¶™‡¶∞‡ßá‡¶∞ ‡¶¶‡¶ø‡¶® ‡¶∏‡¶ï‡¶æ‡¶≤ ${next.paran_start || "--"}‚Äì${next.paran_end || "--"} ${
        next.verified ? "‚úÖ (" + next.verified + ")" : ""
      }`;
    document.querySelector(".load-status").style.display = "none";

    // Annual List section
    const table = document.querySelector(".annual-ekadashi tbody");
    table.innerHTML = sorted
      .map(
        e => `
        <tr>
          <td>${e.name}</td>
          <td>${e.date}</td>
          <td>${e.paran_start ? `‡¶™‡¶∞‡ßá‡¶∞ ‡¶¶‡¶ø‡¶® ‡¶∏‡¶ï‡¶æ‡¶≤ ${e.paran_start}‚Äì${e.paran_end}` : "-"}</td>
        </tr>`
      )
      .join("");
  } catch (err) {
    console.error(err);
    document.querySelector(".ekadashi-name").innerText = "‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‚Ä¶";
  }
}

// Run on load
loadEkadashiData();

  
/* ===== Utility ===== */
const pad = n => String(n).padStart(2,"0");
const isoToDMY = iso => { const [y,m,d]=iso.split("-"); return `${pad(+d)}-${pad(+m)}-${y}` };
const daysLeft = (iso) => {
  const a = new Date(iso+"T00:00:00+05:30"); // IST assume
  const b = new Date();
  const diff = Math.ceil((a - b)/(24*3600*1000));
  return diff;
};
function sortByDate(list){ return [...list].sort((x,y)=> x.date_iso.localeCompare(y.date_iso)); }

/* ===== Data loaders (fallback: ISKCON -> LOCAL_JSON -> CACHE) ===== */
async function tryFetch(url,label){
  if(!url) throw new Error("empty-url");
  const r = await fetch(url,{cache:"no-store"});
  if(!r.ok) throw new Error(label+" HTTP "+r.status);
  const data = await r.json();
  if(!Array.isArray(data)) throw new Error(label+" invalid JSON");
  return {label, data};
}

async function loadAll(){
  let source = null;
  let data = null;

  // 1) ISKCON
  try{
    if(ISKCON_URL){
      const res = await tryFetch(ISKCON_URL,"ISKCON");
      source = res.label; data = res.data.map(x=>({...x, verified:true}));
    }
  }catch(e){ /* skip */ }

  // 2) LOCAL JSON (same-origin)
  if(!data){
    try{
      const res = await tryFetch(LOCAL_JSON,"LOCAL");
      // ‡¶Ø‡¶¶‡¶ø ISKCON ‡¶Ü‡¶ó‡ßá ‡¶®‡¶æ ‡¶Ü‡¶∏‡ßá, verified=false
      source = res.label; data = res.data.map(x=>({...x, verified: x.verified ?? false}));
    }catch(e){ /* skip */ }
  }

  // 3) CACHE (localStorage)
  if(!data){
    const stash = localStorage.getItem("ekadashi_cache");
    if(stash){
      source = "CACHE";
      data = JSON.parse(stash);
    }
  }

  if(!data) throw new Error("No data from any source.");
  // 24‡¶ü‡¶ø ‡¶∞‡¶æ‡¶ñ‡¶ø, sorted
  data = sortByDate(data).slice(0,24);
  // cache save
  localStorage.setItem("ekadashi_cache", JSON.stringify(data));
  localStorage.setItem("ekadashi_cache_time", new Date().toISOString());
  return {source, data};
}

/* ===== Renderers ===== */
function renderCard(upcoming, sourceLabel){
  document.getElementById("ekName").textContent = upcoming.name_bn || "‚Äî";
  document.getElementById("ekDate").textContent = isoToDMY(upcoming.date_iso);
  document.getElementById("ddays").textContent = Math.max(0, daysLeft(upcoming.date_iso));
  document.getElementById("ekParana").textContent = upcoming.parana_bn || "‚Äî";
  const tick = document.getElementById("vTick");
  tick.style.display = upcoming.verified ? "inline" : "none";
  const st = document.getElementById("sourceTag");
  st.textContent = "‡¶∏‡ßã‡¶∞‡ßç‡¶∏: " + (sourceLabel === "ISKCON" ? "ISKCON ‚úÖ" :
                                 sourceLabel === "LOCAL"  ? "Madhavam PanjikƒÅ" :
                                 "Cached");
}

function renderTables(list){
  const rows = list.map(x=>`<tr><td>${x.name_bn}</td><td>${isoToDMY(x.date_iso)}</td><td>${x.parana_bn||"‚Äî"}</td></tr>`).join("");
  document.getElementById("tblBody").innerHTML = rows || `<tr><td colspan="3" class="center">‡¶ï‡ßã‡¶®‡ßã ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</td></tr>`;
  document.getElementById("tblBodyPop").innerHTML = rows || `<tr><td colspan="3" class="center">‡¶ï‡ßã‡¶®‡ßã ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</td></tr>`;
}

/* ===== Sunrise-based refresh (simple) + 12h backup =====
   - ‡¶™‡ßç‡¶∞‡¶§‡¶ø 12 ‡¶ò‡¶®‡ßç‡¶ü‡¶æ‡ßü ‡¶è‡¶ï‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶ï
   - ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶¨‡¶¶‡¶≤‡¶æ‡¶≤‡ßá (‡¶≤‡ßã‡¶ï‡¶æ‡¶≤) ‡¶´‡ßã‡¶∞‡ßç‡¶∏ ‡¶∞‡¶ø‡¶≤‡ßã‡¶°
*/
function scheduleAutoRefresh(){
  // 12h
  setInterval(()=>location.reload(), 12*60*60*1000);
  // local date flip
  const startDay = new Date().getDate();
  setInterval(()=>{
    if(new Date().getDate() !== startDay) location.reload();
  }, 30*60*1000);
}

/* ===== Init ===== */
(async function init(){
  // IST Badge
  document.getElementById("tzBadge").textContent = "IST ‚Ä¢ UTC+05:30";

  try{
    const {source, data} = await loadAll();
    // pick upcoming
    const todayISO = new Date().toISOString().slice(0,10);
    const upcoming = sortByDate(data).find(x=>x.date_iso >= todayISO) || data[0];
    renderCard(upcoming, source);
    renderTables(data);
  }catch(e){
    document.getElementById("ekName").textContent = "‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶°‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‚Ä¶";
    console.error(e);
  }

  scheduleAutoRefresh();
})();

/* Popup controls */
const pop = document.getElementById("popup");
document.getElementById("openList").addEventListener("click", ()=> pop.showModal());
document.getElementById("closePop").addEventListener("click", ()=> pop.close());
pop.addEventListener("click", (e)=>{ if(e.target===pop) pop.close(); });
</script>
</body>
</html>
